Ext.form.HtmlEditor=Ext.extend(Ext.form.Field,{enableFormat:true,enableFontSize:true,enableColors:true,enableAlignments:true,enableLists:true,enableSourceEdit:true,enableLinks:true,enableFont:true,createLinkText:"Please enter the URL for the link:",defaultLinkValue:"http://",fontFamilies:["Arial","Courier New","tahoma","Times New Roman","Verdana"],defaultFont:"tahoma",validationEvent:false,deferHeight:true,initialized:false,activated:false,sourceEditMode:false,onFocus:Ext.emptyFn,iframePad:3,hideMode:"offsets",defaultAutoCreate:{tag:"textarea",style:"width:500px;height:300px;",autocomplete:"off"},initComponent:function(){this.addEvents("initialize","activate","beforesync","beforepush","sync","push","editmodechange")},createFontOptions:function(){var k=[],g=this.fontFamilies,l,i;for(var j=0,h=g.length;j<h;j++){l=g[j];i=l.toLowerCase();k.push('<option value="',i,'" style="font-family:',l,';"',(this.defaultFont==i?' selected="true">':">"),l,"</option>")}return k.join("")},createToolbar:function(g){var f=Ext.QuickTips&&Ext.QuickTips.isEnabled();function h(a,c,b){return{itemId:a,cls:"x-btn-icon x-edit-"+a,enableToggle:c!==false,scope:g,handler:b||g.relayBtnCmd,clickEvent:"mousedown",tooltip:f?g.buttonTips[a]||undefined:undefined,tabIndex:-1}}var e=new Ext.Toolbar({renderTo:this.wrap.dom.firstChild});e.el.on("click",function(a){a.preventDefault()});if(this.enableFont&&!Ext.isSafari2){this.fontSelect=e.el.createChild({tag:"select",cls:"x-font-select",html:this.createFontOptions()});this.fontSelect.on("change",function(){var a=this.fontSelect.dom.value;this.relayCmd("fontname",a);this.deferFocus()},this);e.add(this.fontSelect.dom,"-")}if(this.enableFormat){e.add(h("bold"),h("italic"),h("underline"))}if(this.enableFontSize){e.add("-",h("increasefontsize",false,this.adjustFont),h("decreasefontsize",false,this.adjustFont))}if(this.enableColors){e.add("-",{itemId:"forecolor",cls:"x-btn-icon x-edit-forecolor",clickEvent:"mousedown",tooltip:f?g.buttonTips.forecolor||undefined:undefined,tabIndex:-1,menu:new Ext.menu.ColorMenu({allowReselect:true,focus:Ext.emptyFn,value:"000000",plain:true,selectHandler:function(a,b){this.execCmd("forecolor",Ext.isSafari||Ext.isIE?"#"+b:b);this.deferFocus()},scope:this,clickEvent:"mousedown"})},{itemId:"backcolor",cls:"x-btn-icon x-edit-backcolor",clickEvent:"mousedown",tooltip:f?g.buttonTips.backcolor||undefined:undefined,tabIndex:-1,menu:new Ext.menu.ColorMenu({focus:Ext.emptyFn,value:"FFFFFF",plain:true,allowReselect:true,selectHandler:function(a,b){if(Ext.isGecko){this.execCmd("useCSS",false);this.execCmd("hilitecolor",b);this.execCmd("useCSS",true);this.deferFocus()}else{this.execCmd(Ext.isOpera?"hilitecolor":"backcolor",Ext.isSafari||Ext.isIE?"#"+b:b);this.deferFocus()}},scope:this,clickEvent:"mousedown"})})}if(this.enableAlignments){e.add("-",h("justifyleft"),h("justifycenter"),h("justifyright"))}if(!Ext.isSafari2){if(this.enableLinks){e.add("-",h("createlink",false,this.createLink))}if(this.enableLists){e.add("-",h("insertorderedlist"),h("insertunorderedlist"))}if(this.enableSourceEdit){e.add("-",h("sourceedit",true,function(a){this.toggleSourceEdit(a.pressed)}))}}this.tb=e},getDocMarkup:function(){return'<html><head><style type="text/css">body{border:0;margin:0;padding:3px;height:98%;cursor:text;}</style></head><body></body></html>'},getEditorBody:function(){return this.doc.body||this.doc.documentElement},getDoc:function(){return Ext.isIE?this.getWin().document:(this.iframe.contentDocument||this.getWin().document)},getWin:function(){return Ext.isIE?this.iframe.contentWindow:window.frames[this.iframe.name]},onRender:function(e,f){Ext.form.HtmlEditor.superclass.onRender.call(this,e,f);this.el.dom.style.border="0 none";this.el.dom.setAttribute("tabIndex",-1);this.el.addClass("x-hidden");if(Ext.isIE){this.el.applyStyles("margin-top:-1px;margin-bottom:-1px;")}this.wrap=this.el.wrap({cls:"x-html-editor-wrap",cn:{cls:"x-html-editor-tb"}});this.createToolbar(this);this.tb.items.each(function(a){if(a.itemId!="sourceedit"){a.disable()}});var h=document.createElement("iframe");h.name=Ext.id();h.frameBorder="0";h.src=Ext.isIE?Ext.SSL_SECURE_URL:"javascript:;";this.wrap.dom.appendChild(h);this.iframe=h;this.initFrame();if(this.autoMonitorDesignMode!==false){this.monitorTask=Ext.TaskMgr.start({run:this.checkDesignMode,scope:this,interval:100})}if(!this.width){var g=this.el.getSize();this.setSize(g.width,this.height||g.height)}},initFrame:function(){this.doc=this.getDoc();this.win=this.getWin();this.doc.open();this.doc.write(this.getDocMarkup());this.doc.close();var b={run:function(){if(this.doc.body||this.doc.readyState=="complete"){Ext.TaskMgr.stop(b);this.doc.designMode="on";this.initEditor.defer(10,this)}},interval:10,duration:10000,scope:this};Ext.TaskMgr.start(b)},checkDesignMode:function(){if(this.wrap&&this.wrap.dom.offsetWidth){var b=this.getDoc();if(!b){return}if(!b.editorInitialized||String(b.designMode).toLowerCase()!="on"){this.initFrame()}}},onResize:function(e,h){Ext.form.HtmlEditor.superclass.onResize.apply(this,arguments);if(this.el&&this.iframe){if(typeof e=="number"){var g=e-this.wrap.getFrameWidth("lr");this.el.setWidth(this.adjustWidth("textarea",g));this.iframe.style.width=Math.max(g,0)+"px"}if(typeof h=="number"){var f=h-this.wrap.getFrameWidth("tb")-this.tb.el.getHeight();this.el.setHeight(this.adjustWidth("textarea",f));this.iframe.style.height=Math.max(f,0)+"px";if(this.doc){this.getEditorBody().style.height=Math.max((f-(this.iframePad*2)),0)+"px"}}}},toggleSourceEdit:function(e){if(e===undefined){e=!this.sourceEditMode}this.sourceEditMode=e===true;var f=this.tb.items.get("sourceedit");if(f.pressed!==this.sourceEditMode){f.toggle(this.sourceEditMode);return}if(this.sourceEditMode){this.tb.items.each(function(a){if(a.itemId!="sourceedit"){a.disable()}});this.syncValue();this.iframe.className="x-hidden";this.el.removeClass("x-hidden");this.el.dom.removeAttribute("tabIndex");this.el.focus()}else{if(this.initialized){this.tb.items.each(function(a){a.enable()})}this.pushValue();this.iframe.className="";this.el.addClass("x-hidden");this.el.dom.setAttribute("tabIndex",-1);this.deferFocus()}var d=this.lastSize;if(d){delete this.lastSize;this.setSize(d)}this.fireEvent("editmodechange",this,this.sourceEditMode)},createLink:function(){var b=prompt(this.createLinkText,this.defaultLinkValue);if(b&&b!="http://"){this.relayCmd("createlink",b)}},adjustSize:Ext.BoxComponent.prototype.adjustSize,getResizeEl:function(){return this.wrap},getPositionEl:function(){return this.wrap},initEvents:function(){this.originalValue=this.getValue()},markInvalid:Ext.emptyFn,clearInvalid:Ext.emptyFn,setValue:function(b){Ext.form.HtmlEditor.superclass.setValue.call(this,b);this.pushValue()},cleanHtml:function(b){b=String(b);if(b.length>5){if(Ext.isSafari){b=b.replace(/\sclass="(?:Apple-style-span|khtml-block-placeholder)"/gi,"")}}if(b=="&nbsp;"){b=""}return b},syncValue:function(){if(this.initialized){var g=this.getEditorBody();var h=g.innerHTML;if(Ext.isSafari){var e=g.getAttribute("style");var f=e.match(/text-align:(.*?);/i);if(f&&f[1]){h='<div dir="rtl" style="'+f[0]+'">'+h+"</div>"}}h=this.cleanHtml(h);if(this.fireEvent("beforesync",this,h)!==false){this.el.dom.value=h;this.fireEvent("sync",this,h)}}},getValue:function(){this.syncValue();return Ext.form.HtmlEditor.superclass.getValue.call(this)},pushValue:function(){if(this.initialized){var b=this.el.dom.value;if(!this.activated&&b.length<1){b="&nbsp;"}if(this.fireEvent("beforepush",this,b)!==false){this.getEditorBody().innerHTML=b;this.fireEvent("push",this,b)}}},deferFocus:function(){this.focus.defer(10,this)},focus:function(){if(this.win&&!this.sourceEditMode){this.win.focus()}else{this.el.focus()}},initEditor:function(){var d=this.getEditorBody();var e=this.el.getStyles("font-size","font-family","background-image","background-repeat");e["background-attachment"]="fixed";d.bgProperties="fixed";Ext.DomHelper.applyStyles(d,e);if(this.doc){try{Ext.EventManager.removeAll(this.doc)}catch(f){}}this.doc=this.getDoc();Ext.EventManager.on(this.doc,{mousedown:this.onEditorEvent,dblclick:this.onEditorEvent,click:this.onEditorEvent,keyup:this.onEditorEvent,buffer:100,scope:this});if(Ext.isGecko){Ext.EventManager.on(this.doc,"keypress",this.applyCommand,this)}if(Ext.isIE||Ext.isSafari||Ext.isOpera){Ext.EventManager.on(this.doc,"keydown",this.fixKeys,this)}this.initialized=true;this.fireEvent("initialize",this);this.doc.editorInitialized=true;this.pushValue()},onDestroy:function(){if(this.monitorTask){Ext.TaskMgr.stop(this.monitorTask)}if(this.rendered){this.tb.items.each(function(b){if(b.menu){b.menu.removeAll();if(b.menu.el){b.menu.el.destroy()}}b.destroy()});this.wrap.dom.innerHTML="";this.wrap.remove()}},onFirstFocus:function(){this.activated=true;this.tb.items.each(function(a){a.enable()});if(Ext.isGecko){this.win.focus();var e=this.win.getSelection();if(!e.focusNode||e.focusNode.nodeType!=3){var d=e.getRangeAt(0);d.selectNodeContents(this.getEditorBody());d.collapse(true);this.deferFocus()}try{this.execCmd("useCSS",true);this.execCmd("styleWithCSS",false)}catch(f){}}this.fireEvent("activate",this)},adjustFont:function(d){var f=d.itemId=="increasefontsize"?1:-1;var e=parseInt(this.doc.queryCommandValue("FontSize")||2,10);if(Ext.isSafari3||Ext.isAir){if(e<=10){e=1+f}else{if(e<=13){e=2+f}else{if(e<=16){e=3+f}else{if(e<=18){e=4+f}else{if(e<=24){e=5+f}else{e=6+f}}}}}e=e.constrain(1,6)}else{if(Ext.isSafari){f*=2}e=Math.max(1,e+f)+(Ext.isSafari?"px":0)}this.execCmd("FontSize",e)},onEditorEvent:function(b){this.updateToolbar()},updateToolbar:function(){if(!this.activated){this.onFirstFocus();return}var d=this.tb.items.map,f=this.doc;if(this.enableFont&&!Ext.isSafari2){var e=(this.doc.queryCommandValue("FontName")||this.defaultFont).toLowerCase();if(e!=this.fontSelect.dom.value){this.fontSelect.dom.value=e}}if(this.enableFormat){d.bold.toggle(f.queryCommandState("bold"));d.italic.toggle(f.queryCommandState("italic"));d.underline.toggle(f.queryCommandState("underline"))}if(this.enableAlignments){d.justifyleft.toggle(f.queryCommandState("justifyleft"));d.justifycenter.toggle(f.queryCommandState("justifycenter"));d.justifyright.toggle(f.queryCommandState("justifyright"))}if(!Ext.isSafari2&&this.enableLists){d.insertorderedlist.toggle(f.queryCommandState("insertorderedlist"));d.insertunorderedlist.toggle(f.queryCommandState("insertunorderedlist"))}Ext.menu.MenuMgr.hideAll();this.syncValue()},relayBtnCmd:function(b){this.relayCmd(b.itemId)},relayCmd:function(c,d){(function(){this.focus();this.execCmd(c,d);this.updateToolbar()}).defer(10,this)},execCmd:function(c,d){this.doc.execCommand(c,false,d===undefined?null:d);this.syncValue()},applyCommand:function(c){if(c.ctrlKey){var f=c.getCharCode(),e;if(f>0){f=String.fromCharCode(f);switch(f){case"b":e="bold";break;case"i":e="italic";break;case"u":e="underline";break}if(e){this.win.focus();this.execCmd(e);this.deferFocus();c.preventDefault()}}}},insertAtCursor:function(c){if(!this.activated){return}if(Ext.isIE){this.win.focus();var d=this.doc.selection.createRange();if(d){d.collapse(true);d.pasteHTML(c);this.syncValue();this.deferFocus()}}else{if(Ext.isGecko||Ext.isOpera){this.win.focus();this.execCmd("InsertHTML",c);this.deferFocus()}else{if(Ext.isSafari){this.execCmd("InsertText",c);this.deferFocus()}}}},fixKeys:function(){if(Ext.isIE){return function(g){var f=g.getKey(),e;if(f==g.TAB){g.stopEvent();e=this.doc.selection.createRange();if(e){e.collapse(true);e.pasteHTML("&nbsp;&nbsp;&nbsp;&nbsp;");this.deferFocus()}}else{if(f==g.ENTER){e=this.doc.selection.createRange();if(e){var h=e.parentElement();if(!h||h.tagName.toLowerCase()!="li"){g.stopEvent();e.pasteHTML("<br />");e.collapse(false);e.select()}}}}}}else{if(Ext.isOpera){return function(c){var d=c.getKey();if(d==c.TAB){c.stopEvent();this.win.focus();this.execCmd("InsertHTML","&nbsp;&nbsp;&nbsp;&nbsp;");this.deferFocus()}}}else{if(Ext.isSafari){return function(c){var d=c.getKey();if(d==c.TAB){c.stopEvent();this.execCmd("InsertText","\t");this.deferFocus()}}}}}}(),getToolbar:function(){return this.tb},buttonTips:{bold:{title:"Bold (Ctrl+B)",text:"Make the selected text bold.",cls:"x-html-editor-tip"},italic:{title:"Italic (Ctrl+I)",text:"Make the selected text italic.",cls:"x-html-editor-tip"},underline:{title:"Underline (Ctrl+U)",text:"Underline the selected text.",cls:"x-html-editor-tip"},increasefontsize:{title:"Grow Text",text:"Increase the font size.",cls:"x-html-editor-tip"},decreasefontsize:{title:"Shrink Text",text:"Decrease the font size.",cls:"x-html-editor-tip"},backcolor:{title:"Text Highlight Color",text:"Change the background color of the selected text.",cls:"x-html-editor-tip"},forecolor:{title:"Font Color",text:"Change the color of the selected text.",cls:"x-html-editor-tip"},justifyleft:{title:"Align Text Left",text:"Align text to the left.",cls:"x-html-editor-tip"},justifycenter:{title:"Center Text",text:"Center text in the editor.",cls:"x-html-editor-tip"},justifyright:{title:"Align Text Right",text:"Align text to the right.",cls:"x-html-editor-tip"},insertunorderedlist:{title:"Bullet List",text:"Start a bulleted list.",cls:"x-html-editor-tip"},insertorderedlist:{title:"Numbered List",text:"Start a numbered list.",cls:"x-html-editor-tip"},createlink:{title:"Hyperlink",text:"Make the selected text a hyperlink.",cls:"x-html-editor-tip"},sourceedit:{title:"Source Edit",text:"Switch to source editing mode.",cls:"x-html-editor-tip"}}});Ext.reg("htmleditor",Ext.form.HtmlEditor);